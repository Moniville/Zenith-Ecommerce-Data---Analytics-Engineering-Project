-- Setting the Context for Analytical Querying

-- Set the Warehouse (Compute Engine)
USE WAREHOUSE ZENITH_WH;

-- Set the Database (The Project Container)
USE DATABASE ZENITH_DB;

-- Set the Schema (The Analytical Folder)
USE SCHEMA ZENITH_DB.ANALYTICS;


-- Which product categories are generating the most revenue for Zenith?

SELECT
    DP.CATEGORY_NAME,
    -- Summing the Calculated Revenue Metric From The Fact_Sales Table
    SUM(FS.REVENUE) AS TOTAL_REVENUE_USD,
    
    --Counting the Number of Unique Orders Involved
    COUNT(DISTINCT FS.ORDER_ID) AS TOTAL_ORDERS
    
FROM
    FACT_SALES FS -- The Table That holds Sales Data

INNER JOIN DIM_PRODUCTS DP 
    ON FS.PRODUCT_ID = DP.PRODUCT_ID
    GROUP BY 1 -- Grouping by Category_Name
    ORDER BY TOTAL_REVENUE_USD DESC;
    

-- Who Are The Most Valuable Customers For Zenith E-Commerce?
SELECT
    DC.CUSTOMER_ID,
    DC.FIRST_NAME,
    DC.LAST_NAME,

    -- Summing The Revenue Metric From The Fact_Sales Table
    SUM(FS.REVENUE) AS LIFETIME_REVENUE_USD,

    -- Count How Many Orders They Have Placed
    COUNT(DISTINCT FS.ORDER_ID) AS TOTAL_ORDERS

FROM
    ANALYTICS.FACT_SALES FS

INNER JOIN ANALYTICS.DIM_CUSTOMERS DC -- Joining The Dimension Table That Contains Customers Data
    ON FS.CUSTOMER_ID = DC.CUSTOMER_ID

GROUP BY
    1, 2, 3 -- Grouping by Customer ID, First Name, Last Name

ORDER BY 
    LIFETIME_REVENUE_USD DESC -- Highest Revenue First
    LIMIT 10; -- Only Show The Top 10
    

-- Which Of Our High-Revenue Products Are Running Low On Stock, Creating A Potential Revenue Risk?
SELECT
    DP.PRODUCT_ID,
    DP.PRODUCT_NAME,
    DP.CATEGORY_NAME,
    
    -- The current stock quantity from the dimension table

    DP.STOCK_QUANTITY,

    -- Total revenue generated by this product
    SUM(FS.REVENUE) AS LIFETIME_PRODUCT_REVENUE
    

FROM 
    ANALYTICS.FACT_SALES FS

INNER JOIN ANALYTICS.DIM_PRODUCTS DP
    ON FS.PRODUCT_ID = DP.PRODUCT_ID

GROUP BY
    1, 2, 3, 4 -- Group by all descriptive columns

-- Filtering for products that are potentially low on stock (e.g., less than 50 units)

HAVING
    DP.STOCK_QUANTITY < 50

ORDER BY
    LIFETIME_PRODUCT_REVENUE DESC -- This shows the highestrevenue, low-stock items first

LIMIT 10;


-- What Is The Average Number of Items Included In A Single Order?

WITH order_aggregates AS (
   -- Calculate the total quantity for each unique order
   SELECT
    ORDER_ID,
    SUM(QUANTITY) AS total_items_in_order
FROM
    ANALYTICS.FACT_SALES

GROUP BY
    ORDER_ID
)

-- Calculate the average across all the orders
SELECT
    AVG(total_items_in_order) AS AVG_ITEMS_PER_ORDER
FROM
    order_aggregates; -- Referencing The CTE above


-- What Are The Most Common City/State Locations For Our Top 20% Of Revenue-Generating Customers?

WITH top_customers AS (

    -- Calculating the Total Revenue for every single customer
    SELECT
        CUSTOMER_ID,
        SUM(REVENUE) AS LIFETIME_REVENUE
    FROM
        ANALYTICS.FACT_SALES
    
    GROUP BY 1
    
    ORDER BY LIFETIME_REVENUE DESC

    -- Using LIMIT Function to approximate the top 20% of customers
    LIMIT 200
)

-- Joining the top spenders to the Customers Dimension table (DIM_CUSTOMERS) to get their location

SELECT
    DC.CITY,
    DC.STATE,
    COUNT(TC.CUSTOMER_ID) AS NUMBER_OF_TOP_CUSTOMERS,
    SUM(TC.LIFETIME_REVENUE) AS TOTAL_REVENUE_FROM_SEGMENT

FROM
    top_customers TC

INNER JOIN ANALYTICS.DIM_CUSTOMERS DC
    ON TC.CUSTOMER_ID = DC.CUSTOMER_ID

GROUP BY
    1, 2

ORDER BY
    TOTAL_REVENUE_FROM_SEGMENT DESC

LIMIT 10;


-- What Were The Total Sales And Revenue For The Top-Performing Quarter Of The Recorded Data?

SELECT
    DD.ORDER_YEAR,
    DD.ORDER_QUARTER,

    -- Total Revenue For The Quarter
    SUM(FS.REVENUE) AS QUARTERLY_REVENUE,

    -- Total Number of Unique Orders For The Quarter
    COUNT(DISTINCT FS.ORDER_ID) AS TOTAL_ORDERS_COUNT
    
FROM
    ANALYTICS.FACT_SALES FS

INNER JOIN ANALYTICS.DIM_DATES DD
    ON FS.DATE_KEY = DD.DATE_KEY

GROUP BY
    1, 2 --Group by Year and Quarter

ORDER BY
    QUARTERLY_REVENUE DESC; -- Find The Best Performing Quarter



-- How Has The Rate of New Customer Acquisition Changed Over The Month?

SELECT
    -- Extract The Year And Month To Group The New Customers
    YEAR(CUSTOMER_SINCE_TS) AS ACQUISITION_YEAR,
    MONTHNAME(CUSTOMER_SINCE_TS) AS ACQUISITION_MONTH,

    -- Count the number of unique customer IDs created in that month
    COUNT(CUSTOMER_ID) AS NEW_CUSTOMERS_ACQUIRED

FROM
    ANALYTICS.DIM_CUSTOMERS DC -- The Customer Dimension Table

GROUP BY
    1, 2, MONTH(CUSTOMER_SINCE_TS)

ORDER BY
    ACQUISITION_YEAR ASC,

    --Using the month number for correct chronical sorting (1, 2, 3....)
    MONTH(CUSTOMER_SINCE_TS) ASC;

-- Which Suppliers Deliver High-Volume (Quantity) and Which Deliver High-Value (Revenue)?

SELECT
    DP.SUPPLIER_NAME,

    -- Total quantity of items sold from supplier(Volume)
    SUM(FS.QUANTITY) AS TOTAL_ITEMS_SOLD,

    -- Total revenue generated from this supplier (Value)
    SUM(FS.REVENUE) AS TOTAL_SUPPLIER_REVENUE

FROM
    ANALYTICS.FACT_SALES FS

INNER JOIN ANALYTICS.DIM_PRODUCTS DP -- Joining the 
    ON FS.PRODUCT_ID = DP.PRODUCT_ID

GROUP BY
    1 -- Group by Supplier Name

ORDER BY
    TOTAL_SUPPLIER_REVENUE DESC -- Order by value to find the most valuable partners

LIMIT 10;


-- Which Payments Methods Are Most Often Used By Customers In Our Highest Revenue Regions?

WITH Top_States AS (
    
    -- Identify the top 5 states by total revenue
    SELECT
        DC.STATE,
        SUM(FS.REVENUE) AS TOTAL_STATE_REVENUE
    
    FROM
        ANALYTICS.FACT_SALES FS

    INNER JOIN ANALYTICS.DIM_CUSTOMERS DC
        ON FS.CUSTOMER_ID = DC.CUSTOMER_ID

    GROUP BY
        DC.STATE

    ORDER BY
        TOTAL_STATE_REVENUE DESC

    LIMIT 5 -- Focusing on the Top 5 States
),

Top_Region_Orders AS (

    -- Filtering the FACT_SALES table to include only orders from the Top States
    SELECT
        FS.PAYMENT_METHOD
    
    FROM
        ANALYTICS.FACT_SALES FS

    INNER JOIN ANALYTICS.DIM_CUSTOMERS DC
       ON FS.CUSTOMER_ID = DC.CUSTOMER_ID
       
    INNER JOIN Top_States TS
        ON DC.STATE = TS.STATE -- Joining on the state identified in the first CTE
)

-- Counting the payment methods in the filtered set of orders
SELECT
    PAYMENT_METHOD,
    COUNT(PAYMENT_METHOD) AS TRANSACTION_COUNT
    
FROM
    Top_Region_Orders
    
GROUP BY
    PAYMENT_METHOD
    
ORDER BY
    TRANSACTION_COUNT DESC;

    SELECT * FROM ANALYTICS.FACT_SALES
